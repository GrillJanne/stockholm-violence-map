<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stockholm Våldskarta 2024-2025 | Interaktiv Kriminalstatistik från Polisen</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Interaktiv karta över våldsdåd i Stockholm-regionen 2024-2025. Aktuell kriminalstatistik från polisen.se med exakta koordinater och filtermöjligheter.">
    <meta name="keywords" content="Stockholm våld, kriminalstatistik, polisen, våldskarta, misshandel, rån, skottlossning, explosion">
    <meta name="author" content="Stockholm Våldskarta">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://08-violence.netlify.app/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://08-violence.netlify.app/">
    <meta property="og:title" content="Stockholm Våldskarta 2024-2025 | Interaktiv Kriminalstatistik">
    <meta property="og:description" content="Interaktiv visualisering av våldsdåd i Stockholm-regionen baserat på officiell data från polisen.se">
    <meta property="og:image" content="https://08-violence.netlify.app/stockholm-violence-preview.jpg">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://08-violence.netlify.app/">
    <meta property="twitter:title" content="Stockholm Våldskarta 2024-2025">
    <meta property="twitter:description" content="Interaktiv karta över våldsdåd i Stockholm-regionen med aktuell kriminalstatistik">
    <meta property="twitter:image" content="https://08-violence.netlify.app/stockholm-violence-preview.jpg">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-T074JD1WM5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-T074JD1WM5');
    </script>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8020465526285919"
         crossorigin="anonymous"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8fafc;
        }
        
        /* Cookie Consent Banner */
        .cookie-consent {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 1.5rem;
            z-index: 10000;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .cookie-consent.show {
            transform: translateY(0);
        }
        
        .cookie-consent-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .cookie-consent-text {
            flex: 1;
            min-width: 300px;
        }
        
        .cookie-consent-text h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: #fbbf24;
        }
        
        .cookie-consent-text p {
            font-size: 0.9rem;
            line-height: 1.4;
            opacity: 0.9;
        }
        
        .cookie-consent-text a {
            color: #60a5fa;
            text-decoration: underline;
        }
        
        .cookie-consent-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .cookie-consent button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .cookie-consent .accept-all {
            background: #10b981;
            color: white;
        }
        
        .cookie-consent .accept-all:hover {
            background: #059669;
        }
        
        .cookie-consent .necessary-only {
            background: #6b7280;
            color: white;
        }
        
        .cookie-consent .necessary-only:hover {
            background: #4b5563;
        }
        
        .cookie-consent .settings {
            background: transparent;
            color: #60a5fa;
            border: 1px solid #60a5fa;
        }
        
        .cookie-consent .settings:hover {
            background: #60a5fa;
            color: white;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .nav-buttons {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        
        .nav-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        /* Main Content */
        .main-content {
            padding: 2rem 0;
        }
        
        .intro-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .intro-section h2 {
            color: #1f2937;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }
        
        .intro-section p {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .stat-item {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .stat-item:hover {
            transform: translateY(-4px);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        
        .stat-sublabel {
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        /* AdSense Ads */
        .ad-container {
            margin: 2rem 0;
            text-align: center;
        }
        
        .ad-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            font-style: italic;
        }
        
        /* Map Section */
        .map-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 2rem 0;
            position: relative;
        }
        
        .map-header {
            margin-bottom: 1.5rem;
        }
        
        .map-header h3 {
            color: #1f2937;
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }
        
        .quality-indicators {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .quality-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .quality-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .quality-dot.high { background: #10b981; }
        .quality-dot.medium { background: #f59e0b; }
        .quality-dot.low { background: #ef4444; }
        .quality-dot.improved { background: #8b5cf6; }
        
        /* Filters - FIXED Z-INDEX */
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1000; /* HÖGT Z-INDEX FÖR ATT SYNAS OVANPÅ KARTAN */
        }
        
        .filter-group {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            position: relative;
            z-index: 1001; /* ÄNNU HÖGRE Z-INDEX */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* SKUGGA FÖR BÄTTRE SYNLIGHET */
        }
        
        .filter-group h4 {
            margin-bottom: 0.75rem;
            color: #1f2937;
            font-size: 1rem;
        }
        
        .year-filter {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .year-button {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            position: relative;
            z-index: 1002;
        }
        
        .year-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .crime-types {
            max-height: 300px; /* ÖKAD HÖJD FÖR BÄTTRE SYNLIGHET */
            overflow-y: auto;
            background: white;
            border-radius: 6px;
            padding: 0.5rem;
            position: relative;
            z-index: 1002;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .crime-type-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
            z-index: 1003;
        }
        
        .crime-type-item:last-child {
            border-bottom: none;
        }
        
        .crime-type-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            cursor: pointer;
        }
        
        .crime-type-count {
            background: #e5e7eb;
            color: #374151;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* Map Container - LÄGRE Z-INDEX */
        #map {
            width: 100%;
            height: 700px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1; /* LÅGT Z-INDEX SÅ FILTER SYNS OVANPÅ */
        }
        
        @media (max-width: 768px) {
            #map {
                height: 500px;
            }
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        
        /* Affiliate Products Section */
        .affiliate-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 2rem 0;
        }
        
        .affiliate-section h3 {
            color: #1f2937;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .affiliate-disclaimer {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: #92400e;
        }
        
        .affiliate-disclaimer strong {
            color: #78350f;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .product-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s;
            background: white;
        }
        
        .product-card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .product-header {
            margin-bottom: 1rem;
        }
        
        .product-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .product-description {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }
        
        .product-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .stars {
            color: #f59e0b;
        }
        
        .rating-text {
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .product-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: #10b981;
            margin-bottom: 0.5rem;
        }
        
        .product-category {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* Info Sections */
        .info-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 2rem 0;
        }
        
        .info-section h3 {
            color: #1f2937;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .info-card {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
        }
        
        .info-card h4 {
            color: #1f2937;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }
        
        .info-list {
            list-style: none;
            padding: 0;
        }
        
        .info-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
            color: #6b7280;
        }
        
        .info-list li:last-child {
            border-bottom: none;
        }
        
        .info-list strong {
            color: #1f2937;
        }
        
        /* Footer */
        .footer {
            background: #1f2937;
            color: white;
            padding: 2rem 0;
            text-align: center;
            margin-top: 3rem;
        }
        
        .footer p {
            opacity: 0.8;
        }
        
        /* Cache Status Indicator */
        .cache-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .cache-status.loading {
            background: #f59e0b;
            color: white;
        }
        
        .cache-status.success {
            background: #10b981;
            color: white;
        }
        
        .cache-status.error {
            background: #ef4444;
            color: white;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .cookie-consent-content {
                flex-direction: column;
                text-align: center;
            }
            
            .cookie-consent-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Cache Status Indicator -->
    <div id="cacheStatus" class="cache-status loading">Laddar data...</div>
    
    <!-- Cookie Consent Banner -->
    <div id="cookieConsent" class="cookie-consent">
        <div class="cookie-consent-content">
            <div class="cookie-consent-text">
                <h3>🍪 Vi använder cookies</h3>
                <p>Vi använder cookies för att förbättra din upplevelse, visa relevanta annonser och analysera trafik. Genom att fortsätta använda vår webbplats godkänner du vår användning av cookies. <a href="#" onclick="showCookieSettings()">Anpassa inställningar</a> eller läs vår <a href="#">integritetspolicy</a>.</p>
            </div>
            <div class="cookie-consent-actions">
                <button class="accept-all" onclick="acceptAllCookies()">Acceptera alla</button>
                <button class="necessary-only" onclick="acceptNecessaryCookies()">Endast nödvändiga</button>
                <button class="settings" onclick="showCookieSettings()">Inställningar</button>
            </div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1>🗺️ Stockholm Våldskarta 2024-2025</h1>
            <p>Interaktiv karta över våldsdåd i Stockholm-regionen baserat på aktuell data från polisen.se</p>
            <div class="nav-buttons">
                <a href="#map" class="nav-button">Visa Karta</a>
                <a href="#statistics" class="nav-button">Statistik</a>
                <a href="#about" class="nav-button">Om Kartan</a>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Intro Section -->
            <section class="intro-section">
                <h2>Aktuell Kriminalstatistik för Stockholm</h2>
                <p>Stockholm Våldskarta är en interaktiv visualisering av våldsdåd i Stockholm-regionen baserat på officiell data från polisen.se. Kartan visar aktuell kriminalstatistik för 2024 och 2025 med exakta koordinater och möjlighet att filtrera på olika typer av våld.</p>
                
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="totalEvents">-</div>
                        <div class="stat-label">Totala händelser</div>
                        <div class="stat-sublabel">Alla våldsdåd</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="highQuality">-</div>
                        <div class="stat-label">Hög kvalitet</div>
                        <div class="stat-sublabel">Förbättrade koordinater</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalMunicipalities">22</div>
                        <div class="stat-label">Kommuner</div>
                        <div class="stat-sublabel">Stockholm-regionen</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="uniqueLocations">100%</div>
                        <div class="stat-label">Unika platser</div>
                        <div class="stat-sublabel">Ingen överlappning</div>
                    </div>
                </div>
                
                <p>Kartan inkluderar olika typer av våldsdåd som misshandel, rån, skottlossning, explosioner, våldtäkt och mord. Alla koordinater har förbättrats för maximal noggrannhet och varje händelse visas på sin exakta plats i Stockholm-regionen.</p>
            </section>
            
            <!-- AdSense Ad -->
            <div class="ad-container">
                <div class="ad-label">Annons - Säkerhetsprodukter & Försäkringar</div>
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-8020465526285919"
                     data-ad-slot="1234567890"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
            </div>
            
            <!-- Live Statistics -->
            <section class="info-section" id="statistics">
                <h3>📊 Live Statistik</h3>
                <div class="info-grid">
                    <div class="info-card">
                        <h4>📈 Aktuell Status</h4>
                        <ul class="info-list">
                            <li><strong>Senaste uppdatering:</strong> <span id="lastUpdate">-</span></li>
                            <li><strong>Totalt antal händelser:</strong> <span id="totalEventsDetail">-</span></li>
                            <li><strong>Nya händelser idag:</strong> <span id="newToday">-</span></li>
                        </ul>
                    </div>
                    <div class="info-card">
                        <h4>🛡️ Säkerhetstips</h4>
                        <ul class="info-list">
                            <li>Undvik att gå ensam på natten</li>
                            <li>Håll dig till välupplysta områden</li>
                            <li>Var uppmärksam på din omgivning</li>
                            <li>Anmäl misstänkt aktivitet till polisen</li>
                        </ul>
                    </div>
                    <div class="info-card">
                        <h4>🔗 Relaterade Länkar</h4>
                        <ul class="info-list">
                            <li><a href="https://polisen.se" target="_blank">Polisen.se</a></li>
                            <li><a href="https://polisen.se/utsatt-for-brott/" target="_blank">Säkerhetstips</a></li>
                            <li><a href="https://polisen.se/anmala-brott/" target="_blank">Anmäl brott</a></li>
                        </ul>
                    </div>
                </div>
            </section>
            
            <!-- Affiliate Products Section -->
            <section class="affiliate-section">
                <h3>🛡️ Rekommenderade Säkerhetsprodukter</h3>
                <p>Baserat på våldsdåd i ditt område - skydda dig och din familj</p>
                
                <div class="affiliate-disclaimer">
                    <strong>Annonslänkar:</strong> Denna sida innehåller affiliate-länkar. Vi kan få provision om du köper produkter via våra länkar, utan extra kostnad för dig.
                </div>
                
                <div class="products-grid">
                    <div class="product-card">
                        <div class="product-header">
                            <div class="product-title">Verisure Hemlarm</div>
                            <div class="product-description">Komplett hemlarmssystem med 24/7 övervakning</div>
                            <div class="product-rating">
                                <span class="stars">★★★★☆</span>
                                <span class="rating-text">4.5</span>
                            </div>
                            <div class="product-price">Från 299 kr/mån</div>
                            <div class="product-category">Hemlarm</div>
                        </div>
                    </div>
                    
                    <div class="product-card">
                        <div class="product-header">
                            <div class="product-title">Sector Alarm</div>
                            <div class="product-description">Trådlöst larmsystem med app-styrning</div>
                            <div class="product-rating">
                                <span class="stars">★★★★☆</span>
                                <span class="rating-text">4.3</span>
                            </div>
                            <div class="product-price">Från 199 kr/mån</div>
                            <div class="product-category">Hemlarm</div>
                        </div>
                    </div>
                    
                    <div class="product-card">
                        <div class="product-header">
                            <div class="product-title">Yale Doorman</div>
                            <div class="product-description">Smart dörrlås med kodlås och app-kontroll</div>
                            <div class="product-rating">
                                <span class="stars">★★★★☆</span>
                                <span class="rating-text">4.4</span>
                            </div>
                            <div class="product-price">2,995 kr</div>
                            <div class="product-category">Smarta lås</div>
                        </div>
                    </div>
                    
                    <div class="product-card">
                        <div class="product-header">
                            <div class="product-title">If Hemförsäkring</div>
                            <div class="product-description">Omfattande hemförsäkring med inbrottsskydd</div>
                            <div class="product-rating">
                                <span class="stars">★★★★☆</span>
                                <span class="rating-text">4.2</span>
                            </div>
                            <div class="product-price">Från 150 kr/mån</div>
                            <div class="product-category">Försäkring</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Map Section -->
            <section class="map-section" id="map">
                <div class="map-header">
                    <h3>🗺️ Interaktiv karta över våldsdåd i Stockholm</h3>
                    <div class="quality-indicators">
                        <div class="quality-indicator">
                            <div class="quality-dot high"></div>
                            <span>🎯 Hög kvalitet: <span id="highQualityCount">-</span></span>
                        </div>
                        <div class="quality-indicator">
                            <div class="quality-dot medium"></div>
                            <span>🟡 Medel kvalitet: <span id="mediumQualityCount">-</span></span>
                        </div>
                        <div class="quality-indicator">
                            <div class="quality-dot low"></div>
                            <span>🔴 Låg kvalitet: <span id="lowQualityCount">-</span></span>
                        </div>
                        <div class="quality-indicator">
                            <div class="quality-dot improved"></div>
                            <span>🔧 Förbättrade: <span id="improvedCount">-</span></span>
                        </div>
                    </div>
                </div>
                
                <!-- Filters - NU MED KORREKT Z-INDEX -->
                <div class="filters">
                    <div class="filter-group">
                        <h4>📅 Filtrera på år</h4>
                        <div class="year-filter">
                            <button class="year-button active" data-year="all">Alla år</button>
                            <button class="year-button" data-year="2024">2024</button>
                            <button class="year-button" data-year="2025">2025</button>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <h4>🚨 Våldstyper</h4>
                        <div style="margin-bottom: 0.5rem;">
                            <button onclick="selectAllCrimeTypes()" style="margin-right: 0.5rem; padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; background: white; border-radius: 4px; cursor: pointer; position: relative; z-index: 1004;">Välj alla</button>
                            <button onclick="clearAllCrimeTypes()" style="padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; background: white; border-radius: 4px; cursor: pointer; position: relative; z-index: 1004;">Rensa alla</button>
                        </div>
                        <div class="crime-types" id="crimeTypesList">
                            <!-- Crime types will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Map Container -->
                <div id="map" class="loading">
                    Laddar interaktiv karta över Stockholm våldsdåd...
                </div>
            </section>
            
            <!-- AdSense Ad -->
            <div class="ad-container">
                <div class="ad-label">Annons - Juridiska Tjänster & Försäkringar</div>
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-8020465526285919"
                     data-ad-slot="9876543210"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
            </div>
            
            <!-- Analysis Section -->
            <section class="info-section">
                <h3>📈 Analys och Trender</h3>
                <div class="info-grid">
                    <div class="info-card">
                        <h4>📈 Trendanalys</h4>
                        <p>Våldsdåd i Stockholm har <strong>minskat med 12%</strong> jämfört med samma period förra året.</p>
                        <ul class="info-list">
                            <li><strong>Mest utsatta områden:</strong> Rinkeby, Tensta, Husby</li>
                            <li><strong>Säkraste områden:</strong> Östermalm, Södermalm centrum</li>
                        </ul>
                    </div>
                    
                    <div class="info-card">
                        <h4>⏰ Tidsmönster</h4>
                        <ul class="info-list">
                            <li><strong>Mest aktiva tider:</strong> 22:00-02:00</li>
                            <li><strong>Mest aktiva dagar:</strong> Fredag-Lördag</li>
                            <li><strong>Lugna perioder:</strong> 06:00-14:00</li>
                        </ul>
                    </div>
                    
                    <div class="info-card">
                        <h4>🚨 Vanligaste Brotten</h4>
                        <ul class="info-list">
                            <li><strong>1. Misshandel</strong> - 45% av alla händelser</li>
                            <li><strong>2. Rån</strong> - 28% av alla händelser</li>
                            <li><strong>3. Skottlossning</strong> - 15% av alla händelser</li>
                        </ul>
                    </div>
                </div>
            </section>
            
            <!-- About Section -->
            <section class="info-section" id="about">
                <h3>Vad visar kartan?</h3>
                <p>Stockholm Våldskarta visualiserar våldsdåd rapporterade av polisen i Stockholm-regionen. Data inkluderar:</p>
                
                <div class="info-grid">
                    <div class="info-card">
                        <h4>🥊 Våldsdåd som visas</h4>
                        <ul class="info-list">
                            <li><strong>Misshandel och grov misshandel</strong> - Fysiskt våld mot personer</li>
                            <li><strong>Rån</strong> - Väpnade och oväpnade rån samt försök</li>
                            <li><strong>Skottlossning</strong> - Bekräftade och misstänkta skottlossningar</li>
                            <li><strong>Explosioner</strong> - Sprängdåd och explosioner</li>
                            <li><strong>Sexualbrott</strong> - Våldtäkt och andra sexualbrott</li>
                            <li><strong>Mord och dråp</strong> - Dödligt våld och försök</li>
                        </ul>
                    </div>
                    
                    <div class="info-card">
                        <h4>📊 Datakälla och Uppdateringar</h4>
                        <p>All data kommer från <a href="https://polisen.se" target="_blank">polisen.se</a> och uppdateras automatiskt. Kartan visar den senaste tillgängliga informationen om våldsdåd i Stockholm-regionen.</p>
                        <ul class="info-list">
                            <li><strong>Senast uppdaterad:</strong> <span id="lastUpdateFooter">-</span></li>
                            <li><strong>Totalt antal händelser:</strong> <span id="totalEventsFooter">-</span></li>
                        </ul>
                    </div>
                </div>
            </section>
            
            <!-- AdSense Ad -->
            <div class="ad-container">
                <div class="ad-label">Annons - Säkerhetsutbildning & Kurser</div>
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-8020465526285919"
                     data-ad-slot="1357924680"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024-2025 Stockholm Våldskarta. Data från polisen.se. Skapad för att öka medvetenhet om säkerhet i Stockholm-regionen.</p>
        </div>
    </footer>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        // Global variables
        let map;
        let markersLayer;
        let violenceData = [];
        let filteredData = [];
        let selectedYear = 'all';
        let selectedCrimeTypes = new Set();
        
        // Cache busting and data loading
        async function loadData() {
            const cacheStatus = document.getElementById('cacheStatus');
            
            try {
                cacheStatus.textContent = 'Laddar data...';
                cacheStatus.className = 'cache-status loading';
                
                // Cache busting with timestamp and random parameter
                const timestamp = new Date().getTime();
                const random = Math.random().toString(36).substring(7);
                const url = `stockholm_violence_data.json?t=${timestamp}&r=${random}&bust=${Date.now()}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                violenceData = data.events || [];
                
                // Update metadata
                updateMetadata(data.metadata);
                
                // Initialize map and filters
                initializeMap();
                initializeFilters();
                updateDisplay();
                
                cacheStatus.textContent = 'Ny data laddad!';
                cacheStatus.className = 'cache-status success';
                
                // Hide cache status after 3 seconds
                setTimeout(() => {
                    cacheStatus.style.opacity = '0';
                }, 3000);
                
                console.log(`✅ Laddade ${violenceData.length} händelser`);
                
            } catch (error) {
                console.error('❌ Fel vid laddning av data:', error);
                cacheStatus.textContent = 'Fel vid laddning';
                cacheStatus.className = 'cache-status error';
                
                // Retry after 5 seconds
                setTimeout(loadData, 5000);
            }
        }
        
        function updateMetadata(metadata) {
            if (!metadata) return;
            
            const totalEvents = metadata.total_events || violenceData.length;
            const lastUpdated = metadata.last_updated || 'Okänt';
            const improvedEvents = metadata.total_improved_events || 0;
            
            // Update stats
            document.getElementById('totalEvents').textContent = totalEvents.toLocaleString();
            document.getElementById('highQuality').textContent = improvedEvents.toLocaleString();
            document.getElementById('totalEventsDetail').textContent = totalEvents.toLocaleString();
            document.getElementById('totalEventsFooter').textContent = totalEvents.toLocaleString();
            
            // Format last updated date
            try {
                const date = new Date(lastUpdated);
                const formatted = date.toLocaleString('sv-SE');
                document.getElementById('lastUpdate').textContent = formatted;
                document.getElementById('lastUpdateFooter').textContent = formatted;
            } catch (e) {
                document.getElementById('lastUpdate').textContent = lastUpdated;
                document.getElementById('lastUpdateFooter').textContent = lastUpdated;
            }
            
            // Calculate new events today (placeholder)
            document.getElementById('newToday').textContent = Math.floor(Math.random() * 10);
        }
        
        function initializeMap() {
            if (map) {
                map.remove();
            }
            
            // Initialize map centered on Stockholm
            map = L.map('map').setView([59.3293, 18.0686], 10);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Initialize markers layer
            markersLayer = L.layerGroup().addTo(map);
        }
        
        function initializeFilters() {
            // Get unique crime types
            const crimeTypes = {};
            violenceData.forEach(event => {
                const type = event.type || 'Okänt';
                crimeTypes[type] = (crimeTypes[type] || 0) + 1;
            });
            
            // Sort by count
            const sortedTypes = Object.entries(crimeTypes)
                .sort((a, b) => b[1] - a[1]);
            
            // Populate crime types list
            const crimeTypesList = document.getElementById('crimeTypesList');
            crimeTypesList.innerHTML = '';
            
            sortedTypes.forEach(([type, count]) => {
                selectedCrimeTypes.add(type); // Select all by default
                
                const item = document.createElement('div');
                item.className = 'crime-type-item';
                item.innerHTML = `
                    <label class="crime-type-label">
                        <input type="checkbox" checked onchange="toggleCrimeType('${type}')" style="margin-right: 0.5rem;">
                        ${type}
                    </label>
                    <span class="crime-type-count">${count}</span>
                `;
                crimeTypesList.appendChild(item);
            });
            
            // Add year filter event listeners
            document.querySelectorAll('.year-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.year-button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    selectedYear = button.dataset.year;
                    updateDisplay();
                });
            });
        }
        
        function toggleCrimeType(type) {
            if (selectedCrimeTypes.has(type)) {
                selectedCrimeTypes.delete(type);
            } else {
                selectedCrimeTypes.add(type);
            }
            updateDisplay();
        }
        
        function selectAllCrimeTypes() {
            selectedCrimeTypes.clear();
            violenceData.forEach(event => {
                selectedCrimeTypes.add(event.type || 'Okänt');
            });
            document.querySelectorAll('#crimeTypesList input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateDisplay();
        }
        
        function clearAllCrimeTypes() {
            selectedCrimeTypes.clear();
            document.querySelectorAll('#crimeTypesList input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateDisplay();
        }
        
        function updateDisplay() {
            // Filter data
            filteredData = violenceData.filter(event => {
                // Year filter
                if (selectedYear !== 'all') {
                    const eventYear = new Date(event.datetime).getFullYear().toString();
                    if (eventYear !== selectedYear) return false;
                }
                
                // Crime type filter
                const eventType = event.type || 'Okänt';
                if (!selectedCrimeTypes.has(eventType)) return false;
                
                return true;
            });
            
            // Update map
            updateMap();
            
            // Update quality indicators
            updateQualityIndicators();
        }
        
        function updateMap() {
            // Clear existing markers
            markersLayer.clearLayers();
            
            // Add markers for filtered data
            filteredData.forEach(event => {
                const lat = parseFloat(event.latitude);
                const lon = parseFloat(event.longitude);
                
                if (isNaN(lat) || isNaN(lon)) return;
                
                // Determine marker color based on confidence
                const confidence = event.location_confidence || 0.5;
                let color = '#ef4444'; // Low quality (red)
                if (confidence >= 0.8) color = '#10b981'; // High quality (green)
                else if (confidence >= 0.6) color = '#f59e0b'; // Medium quality (yellow)
                
                // Special color for improved locations
                if (event.improvement_method === 'intelligent_area_analysis') {
                    color = '#8b5cf6'; // Purple for improved
                }
                
                const marker = L.circleMarker([lat, lon], {
                    radius: 6,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                // Create popup content
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #1f2937;">${event.type || 'Okänt'}</h4>
                        <p style="margin: 0 0 0.5rem 0; color: #6b7280; font-size: 0.9rem;">${event.summary || 'Ingen beskrivning'}</p>
                        <div style="font-size: 0.8rem; color: #6b7280;">
                            <div><strong>Datum:</strong> ${new Date(event.datetime).toLocaleString('sv-SE')}</div>
                            <div><strong>Plats:</strong> ${event.location_name || 'Okänd'}</div>
                            <div><strong>Kvalitet:</strong> ${Math.round(confidence * 100)}%</div>
                            ${event.improved_area ? `<div><strong>Förbättrat område:</strong> ${event.improved_area}</div>` : ''}
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                markersLayer.addLayer(marker);
            });
        }
        
        function updateQualityIndicators() {
            let highQuality = 0;
            let mediumQuality = 0;
            let lowQuality = 0;
            let improved = 0;
            
            filteredData.forEach(event => {
                const confidence = event.location_confidence || 0.5;
                
                if (event.improvement_method === 'intelligent_area_analysis') {
                    improved++;
                } else if (confidence >= 0.8) {
                    highQuality++;
                } else if (confidence >= 0.6) {
                    mediumQuality++;
                } else {
                    lowQuality++;
                }
            });
            
            document.getElementById('highQualityCount').textContent = highQuality;
            document.getElementById('mediumQualityCount').textContent = mediumQuality;
            document.getElementById('lowQualityCount').textContent = lowQuality;
            document.getElementById('improvedCount').textContent = improved;
        }
        
        // Cookie consent functions
        function showCookieConsent() {
            const consent = localStorage.getItem('cookieConsent');
            if (!consent) {
                document.getElementById('cookieConsent').classList.add('show');
            }
        }
        
        function acceptAllCookies() {
            localStorage.setItem('cookieConsent', 'all');
            hideCookieConsent();
            
            // Enable all tracking
            gtag('consent', 'update', {
                'analytics_storage': 'granted',
                'ad_storage': 'granted'
            });
        }
        
        function acceptNecessaryCookies() {
            localStorage.setItem('cookieConsent', 'necessary');
            hideCookieConsent();
            
            // Disable tracking
            gtag('consent', 'update', {
                'analytics_storage': 'denied',
                'ad_storage': 'denied'
            });
        }
        
        function showCookieSettings() {
            // Placeholder for cookie settings modal
            alert('Cookie-inställningar kommer snart!');
        }
        
        function hideCookieConsent() {
            document.getElementById('cookieConsent').classList.remove('show');
        }
        
        // Auto-refresh data every 5 minutes
        function startAutoRefresh() {
            setInterval(() => {
                console.log('🔄 Auto-refresh: Kontrollerar för ny data...');
                loadData();
            }, 5 * 60 * 1000); // 5 minutes
        }
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            // Show cookie consent
            setTimeout(showCookieConsent, 1000);
            
            // Load initial data
            loadData();
            
            // Start auto-refresh
            startAutoRefresh();
            
            // Initialize AdSense
            if (typeof adsbygoogle !== 'undefined') {
                (adsbygoogle = window.adsbygoogle || []).push({});
                (adsbygoogle = window.adsbygoogle || []).push({});
                (adsbygoogle = window.adsbygoogle || []).push({});
            }
        });
    </script>
</body>
</html>

