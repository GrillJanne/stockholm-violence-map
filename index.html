<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stockholm Våldskarta 2024-2025 | Interaktiv Kriminalstatistik från Polisen</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Interaktiv karta över våldsdåd i Stockholm-regionen 2024-2025. Aktuell kriminalstatistik från polisen.se med exakta koordinater och filtermöjligheter.">
    <meta name="keywords" content="Stockholm våld, kriminalstatistik, polisen, våldskarta, misshandel, rån, skottlossning, explosion">
    <meta name="author" content="Stockholm Våldskarta">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://08-violence.netlify.app/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://08-violence.netlify.app/">
    <meta property="og:title" content="Stockholm Våldskarta 2024-2025 | Interaktiv Kriminalstatistik">
    <meta property="og:description" content="Interaktiv visualisering av våldsdåd i Stockholm-regionen baserat på officiell data från polisen.se">
    <meta property="og:image" content="https://08-violence.netlify.app/stockholm-violence-preview.jpg">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://08-violence.netlify.app/">
    <meta property="twitter:title" content="Stockholm Våldskarta 2024-2025">
    <meta property="twitter:description" content="Interaktiv karta över våldsdåd i Stockholm-regionen med aktuell kriminalstatistik">
    <meta property="twitter:image" content="https://08-violence.netlify.app/stockholm-violence-preview.jpg">
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Stockholm Våldskarta",
      "description": "Interaktiv karta över våldsdåd i Stockholm-regionen baserat på officiell data från polisen.se",
      "url": "https://08-violence.netlify.app/",
      "applicationCategory": "DataVisualization",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "SEK"
      }
    }
    </script>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-T074JD1WM5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-T074JD1WM5');
    </script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8fafc;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 1rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .nav {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .nav a {
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            color: white;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .nav a:nth-child(1) { background-color: #10b981; }
        .nav a:nth-child(2) { background-color: #3b82f6; }
        .nav a:nth-child(3) { background-color: #f59e0b; }
        .nav a:nth-child(4) { background-color: #8b5cf6; }
        
        .nav a:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .intro {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .intro h2 {
            color: #1f2937;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .stat-card {
            text-align: center;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            display: block;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .content-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .content-section h3 {
            color: #1f2937;
            margin-bottom: 1rem;
            font-size: 1.4rem;
        }
        
        .content-section ul {
            list-style: none;
            padding-left: 0;
        }
        
        .content-section li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .content-section li:last-child {
            border-bottom: none;
        }
        
        .content-section strong {
            color: #374151;
        }
        
        .map-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .map-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .map-header h3 {
            color: #1f2937;
            font-size: 1.4rem;
            margin: 0;
        }
        
        .quality-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
        }
        
        .quality-stat {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .quality-high { background-color: #dcfce7; color: #166534; }
        .quality-medium { background-color: #fef3c7; color: #92400e; }
        .quality-low { background-color: #fee2e2; color: #991b1b; }
        .quality-improved { background-color: #dbeafe; color: #1e40af; }
        
        .filters {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .filter-group {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .filter-group h4 {
            color: #374151;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .year-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .year-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .year-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .year-btn:hover {
            border-color: #667eea;
        }
        
        .type-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .control-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .control-btn:hover {
            background: #f3f4f6;
        }
        
        .violence-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
        }
        
        .type-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .type-checkbox:hover {
            background-color: #f3f4f6;
        }
        
        .type-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .type-checkbox label {
            cursor: pointer;
            font-size: 0.9rem;
            flex: 1;
        }
        
        .type-count {
            background: #e5e7eb;
            color: #374151;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        #map-canvas {
            height: 600px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            position: relative;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #6b7280;
            font-size: 1.1rem;
        }
        
        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .leaflet-popup-content {
            font-family: inherit;
            line-height: 1.4;
        }
        
        .popup-header {
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .popup-date {
            color: #6b7280;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        .popup-summary {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .popup-location {
            color: #374151;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        .popup-quality {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .marker-enhanced {
            border: 2px solid #10b981 !important;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .filters {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .violence-types {
                grid-template-columns: 1fr;
            }
            
            #map-canvas {
                height: 400px;
            }
        }
        
        /* Cache status indicator */
        .cache-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.8rem;
            z-index: 1000;
            display: none;
        }
        
        .cache-status.show {
            display: block;
        }
        
        .cache-status.fresh {
            background: rgba(16, 185, 129, 0.9);
        }
        
        .cache-status.cached {
            background: rgba(245, 158, 11, 0.9);
        }
    </style>
</head>
<body>
    <!-- Cache status indicator -->
    <div id="cache-status" class="cache-status"></div>
    
    <header class="header">
        <h1>🗺️ Stockholm Våldskarta 2024-2025</h1>
        <p>Interaktiv karta över våldsdåd i Stockholm-regionen baserat på aktuell data från polisen.se</p>
        
        <nav class="nav">
            <a href="#map">Visa Karta</a>
            <a href="#statistics">Statistik</a>
            <a href="#about">Om Kartan</a>
            <a href="#data-source">Datakälla</a>
        </nav>
    </header>
    
    <div class="container">
        <section class="intro">
            <h2>Aktuell Kriminalstatistik för Stockholm</h2>
            <p>Stockholm Våldskarta är en interaktiv visualisering av våldsdåd i Stockholm-regionen baserat på officiell data från polisen.se. Kartan visar aktuell kriminalstatistik för 2024 och 2025 med exakta koordinater och möjlighet att filtrera på olika typer av våld.</p>
            
            <div class="stats">
                <div class="stat-card">
                    <span class="stat-number" id="total-events">198</span>
                    <div class="stat-label">Totala händelser</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="high-quality">145</span>
                    <div class="stat-label">Hög kvalitet</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="municipalities">22</span>
                    <div class="stat-label">Kommuner</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="unique-locations">100%</span>
                    <div class="stat-label">Unika platser</div>
                </div>
            </div>
            
            <p>Kartan inkluderar olika typer av våldsdåd som misshandel, rån, skottlossning, explosioner, våldtäkt och mord. Alla koordinater har förbättrats för maximal noggrannhet och varje händelse visas på sin exakta plats i Stockholm-regionen.</p>
        </section>
        
        <section id="about" class="content-section">
            <h3>Vad visar kartan?</h3>
            <p>Stockholm Våldskarta visualiserar våldsdåd rapporterade av polisen i Stockholm-regionen. Data inkluderar:</p>
            <ul>
                <li><strong>Misshandel och grov misshandel</strong> - Fysiskt våld mot personer</li>
                <li><strong>Rån</strong> - Väpnade och oväpnade rån samt försök</li>
                <li><strong>Skottlossning</strong> - Bekräftade och misstänkta skottlossningar</li>
                <li><strong>Explosioner</strong> - Sprängdåd och explosioner</li>
                <li><strong>Sexualbrott</strong> - Våldtäkt och andra sexualbrott</li>
                <li><strong>Mord och dråp</strong> - Dödligt våld och försök</li>
            </ul>
        </section>
        
        <section class="content-section">
            <h3>Hur används kartan?</h3>
            <p>Använd filtren för att visa specifika år (2024 eller 2025) eller typer av våld. Klicka på markörer för detaljerad information om varje händelse. Kartan uppdateras automatiskt baserat på dina filterval och visar live statistik över vald data.</p>
        </section>
        
        <section id="map" class="map-section">
            <div class="map-header">
                <h3>🗺️ Interaktiv karta över våldsdåd i Stockholm</h3>
            </div>
            
            <div class="quality-stats">
                <span class="quality-stat quality-high">🎯 Hög kvalitet: <span id="quality-high">187</span></span>
                <span class="quality-stat quality-medium">🟡 Medel kvalitet: <span id="quality-medium">53</span></span>
                <span class="quality-stat quality-low">🔴 Låg kvalitet: <span id="quality-low">0</span></span>
                <span class="quality-stat quality-improved">🔧 Förbättrade: <span id="quality-improved">229</span></span>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <h4>📅 Filtrera på år</h4>
                    <div class="year-filters">
                        <button class="year-btn active" data-year="all">Alla år</button>
                        <button class="year-btn" data-year="2024">2024</button>
                        <button class="year-btn" data-year="2025">2025</button>
                    </div>
                </div>
                
                <div class="filter-group">
                    <h4>🚨 Våldstyper</h4>
                    <div class="type-controls">
                        <button class="control-btn" id="select-all">Välj alla</button>
                        <button class="control-btn" id="clear-all">Rensa alla</button>
                    </div>
                    <div class="violence-types" id="violence-types">
                        <!-- Violence type checkboxes will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <div id="map-canvas" class="loading">
                Laddar interaktiv karta över Stockholm våldsdåd...
            </div>
        </section>
        
        <section id="data-source" class="content-section">
            <h3>📊 Datakälla och Uppdateringar</h3>
            <p>All data kommer från <a href="https://polisen.se" target="_blank" rel="noopener">polisen.se</a> och uppdateras automatiskt. Kartan visar den senaste tillgängliga informationen om våldsdåd i Stockholm-regionen.</p>
            <p><strong>Senast uppdaterad:</strong> <span id="last-updated">Laddar...</span></p>
            <p><strong>Totalt antal händelser:</strong> <span id="data-total">Laddar...</span></p>
        </section>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
      // Global variables
      let map;
      let allEvents = [];
      let filteredEvents = [];
      let markersLayer;
      let selectedYear = 'all';
      let selectedTypes = new Set();
      let lastDataUpdate = null;
      
      // Initialize the application
      document.addEventListener('DOMContentLoaded', function() {
        initializeMap();
        loadData();
        setupEventListeners();
      });
      
      function initializeMap() {
        // Initialize map centered on Stockholm
        map = L.map('map-canvas').setView([59.3293, 18.0686], 10);
        
        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Create markers layer group
        markersLayer = L.layerGroup().addTo(map);
      }
      
      // 🔧 CACHE-FIX: Förbättrad loadData-funktion med cache-busting
      async function loadData() {
        const cacheStatus = document.getElementById('cache-status');
        
        try {
          // Cache-busting: Lägg till timestamp för att tvinga fram ny data
          const timestamp = new Date().getTime();
          const cacheParam = `?v=${timestamp}&_=${Math.random()}`;
          
          // Visa cache-status
          showCacheStatus('Laddar ny data...', 'loading');
          
          console.log('🔄 Laddar JSON-data med cache-busting:', `./stockholm_violence_data.json${cacheParam}`);
          
          const response = await fetch(`./stockholm_violence_data.json${cacheParam}`, {
            cache: 'no-cache',
            headers: {
              'Cache-Control': 'no-cache, no-store, must-revalidate',
              'Pragma': 'no-cache',
              'Expires': '0'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          
          // Kontrollera om data är ny
          const isNewData = !lastDataUpdate || data.metadata?.last_updated !== lastDataUpdate;
          
          if (isNewData) {
            console.log('✅ Ny data laddad:', data.metadata);
            showCacheStatus('Ny data laddad!', 'fresh');
            lastDataUpdate = data.metadata?.last_updated;
          } else {
            console.log('ℹ️ Samma data som tidigare');
            showCacheStatus('Data uppdaterad', 'cached');
          }
          
          allEvents = data.events || [];
          
          // Uppdatera metadata på sidan
          updateMetadata(data.metadata);
          
          // Initialize violence types
          initializeViolenceTypes();
          
          // Initial filter and display
          filterAndDisplayEvents();
          
          // Update stats
          updateStats();
          
          // Dölj cache-status efter 3 sekunder
          setTimeout(() => {
            cacheStatus.classList.remove('show');
          }, 3000);
          
          // Track successful data load
          if (typeof gtag !== 'undefined') {
            gtag('event', 'data_loaded', {
              'event_category': 'app_interaction',
              'value': allEvents.length,
              'custom_parameters': {
                'cache_busted': isNewData,
                'data_timestamp': data.metadata?.last_updated
              }
            });
          }
          
        } catch (error) {
          console.error('❌ Error loading data:', error);
          showCacheStatus('Fel vid laddning!', 'error');
          
          document.getElementById('map-canvas').innerHTML = 
            `<div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; color: #ef4444; text-align: center;">
              <h3>Fel vid laddning av data</h3>
              <p>Kontrollera att stockholm_violence_data.json finns och är tillgänglig.</p>
              <p style="font-size: 0.9rem; color: #6b7280; margin-top: 1rem;">Fel: ${error.message}</p>
              <button onclick="loadData()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Försök igen</button>
            </div>`;
            
          // Track error
          if (typeof gtag !== 'undefined') {
            gtag('event', 'data_load_error', {
              'event_category': 'app_error',
              'value': 1,
              'custom_parameters': {
                'error_message': error.message
              }
            });
          }
        }
      }
      
      // Visa cache-status
      function showCacheStatus(message, type) {
        const cacheStatus = document.getElementById('cache-status');
        cacheStatus.textContent = message;
        cacheStatus.className = `cache-status show ${type}`;
      }
      
      // Uppdatera metadata på sidan
      function updateMetadata(metadata) {
        if (metadata) {
          const lastUpdatedElement = document.getElementById('last-updated');
          const dataTotalElement = document.getElementById('data-total');
          
          if (lastUpdatedElement && metadata.last_updated) {
            const date = new Date(metadata.last_updated);
            lastUpdatedElement.textContent = date.toLocaleString('sv-SE');
          }
          
          if (dataTotalElement && metadata.total_events) {
            dataTotalElement.textContent = metadata.total_events;
          }
          
          // Uppdatera huvudstatistik
          const totalEventsElement = document.getElementById('total-events');
          if (totalEventsElement && metadata.total_events) {
            totalEventsElement.textContent = metadata.total_events;
          }
        }
      }
      
      function initializeViolenceTypes() {
        const types = {};
        
        allEvents.forEach(event => {
          const type = event.type || 'Okänd';
          types[type] = (types[type] || 0) + 1;
        });
        
        const container = document.getElementById('violence-types');
        container.innerHTML = '';
        
        // Sort types by count (descending)
        const sortedTypes = Object.entries(types).sort((a, b) => b[1] - a[1]);
        
        sortedTypes.forEach(([type, count]) => {
          const checkbox = document.createElement('div');
          checkbox.className = 'type-checkbox';
          
          const input = document.createElement('input');
          input.type = 'checkbox';
          input.id = `type-${type}`;
          input.checked = true;
          input.setAttribute('aria-label', `Filtrera ${type}`);
          
          const label = document.createElement('label');
          label.htmlFor = `type-${type}`;
          label.textContent = type;
          
          const countSpan = document.createElement('span');
          countSpan.className = 'type-count';
          countSpan.textContent = count;
          
          checkbox.appendChild(input);
          checkbox.appendChild(label);
          checkbox.appendChild(countSpan);
          container.appendChild(checkbox);
          
          selectedTypes.add(type);
          
          input.addEventListener('change', function() {
            if (this.checked) {
              selectedTypes.add(type);
            } else {
              selectedTypes.delete(type);
            }
            filterAndDisplayEvents();
            updateStats();
            
            // Track filter usage
            if (typeof gtag !== 'undefined') {
              gtag('event', 'filter_violence_type', {
                'event_category': 'user_interaction',
                'event_label': type,
                'value': this.checked ? 1 : 0
              });
            }
          });
        });
      }
      
      function setupEventListeners() {
        // Year filter buttons
        document.querySelectorAll('.year-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            selectedYear = this.dataset.year;
            filterAndDisplayEvents();
            updateStats();
            
            // Track year filter usage
            if (typeof gtag !== 'undefined') {
              gtag('event', 'filter_year', {
                'event_category': 'user_interaction',
                'event_label': selectedYear,
                'value': 1
              });
            }
          });
        });
        
        // Select all / Clear all buttons
        document.getElementById('select-all').addEventListener('click', function() {
          document.querySelectorAll('#violence-types input[type="checkbox"]').forEach(cb => {
            cb.checked = true;
            selectedTypes.add(cb.id.replace('type-', ''));
          });
          filterAndDisplayEvents();
          updateStats();
          
          if (typeof gtag !== 'undefined') {
            gtag('event', 'select_all_types', {
              'event_category': 'user_interaction',
              'value': 1
            });
          }
        });
        
        document.getElementById('clear-all').addEventListener('click', function() {
          document.querySelectorAll('#violence-types input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
          });
          selectedTypes.clear();
          filterAndDisplayEvents();
          updateStats();
          
          if (typeof gtag !== 'undefined') {
            gtag('event', 'clear_all_types', {
              'event_category': 'user_interaction',
              'value': 1
            });
          }
        });
        
        // Smooth scrolling for navigation links
        document.querySelectorAll('.nav a').forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
              targetElement.scrollIntoView({ behavior: 'smooth' });
            }
          });
        });
        
        // Auto-refresh data every 5 minutes
        setInterval(() => {
          console.log('🔄 Auto-refresh: Kontrollerar för ny data...');
          loadData();
        }, 5 * 60 * 1000); // 5 minuter
      }
      
      function filterAndDisplayEvents() {
        filteredEvents = allEvents.filter(event => {
          // Year filter
          if (selectedYear !== 'all') {
            const eventYear = new Date(event.datetime).getFullYear().toString();
            if (eventYear !== selectedYear) return false;
          }
          
          // Type filter
          const eventType = event.type || 'Okänd';
          if (!selectedTypes.has(eventType)) return false;
          
          return true;
        });
        
        displayEventsOnMap();
      }
      
      function displayEventsOnMap() {
        // Clear existing markers
        markersLayer.clearLayers();
        
        filteredEvents.forEach(event => {
          const lat = parseFloat(event.latitude);
          const lon = parseFloat(event.longitude);
          
          if (isNaN(lat) || isNaN(lon)) return;
          
          // Determine marker color based on violence type
          let color = '#ef4444'; // Default red
          const type = (event.type || '').toLowerCase();
          
          if (type.includes('misshandel')) color = '#f59e0b';
          else if (type.includes('rån')) color = '#8b5cf6';
          else if (type.includes('skottlossning')) color = '#ef4444';
          else if (type.includes('explosion')) color = '#dc2626';
          else if (type.includes('våldtäkt') || type.includes('sexualbrott')) color = '#ec4899';
          else if (type.includes('mord') || type.includes('dråp')) color = '#7c2d12';
          
          // Determine quality icon
          let qualityIcon = '📍';
          const confidence = parseFloat(event.location_confidence || 0);
          
          if (confidence >= 0.9) qualityIcon = '🎯';
          else if (confidence >= 0.8) qualityIcon = '👤';
          else if (confidence >= 0.75) qualityIcon = '📍';
          else if (confidence >= 0.65) qualityIcon = '🔧';
          else if (confidence >= 0.5) qualityIcon = '⚙️';
          else qualityIcon = '📌';
          
          const marker = L.circleMarker([lat, lon], {
            radius: 8,
            fillColor: color,
            color: '#ffffff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
          });
          
          // Add green border for enhanced coordinates
          if (event.correction_method && event.correction_method !== 'original') {
            marker.setStyle({ color: '#10b981', weight: 3 });
            marker.getElement()?.classList.add('marker-enhanced');
          }
          
          // Create popup content
          const popupContent = `
            <div class="popup-header">${qualityIcon} ${event.type || 'Okänd händelse'}</div>
            <div class="popup-date">${new Date(event.datetime).toLocaleString('sv-SE')}</div>
            <div class="popup-summary">${event.summary || 'Ingen beskrivning tillgänglig'}</div>
            <div class="popup-location">📍 ${event.location_name || 'Okänd plats'}</div>
            <div class="popup-quality quality-${confidence >= 0.75 ? 'high' : confidence >= 0.5 ? 'medium' : 'low'}">
              Kvalitet: ${Math.round(confidence * 100)}%
            </div>
          `;
          
          marker.bindPopup(popupContent);
          
          // Track marker clicks
          marker.on('click', function() {
            if (typeof gtag !== 'undefined') {
              gtag('event', 'marker_click', {
                'event_category': 'user_interaction',
                'event_label': event.type,
                'value': 1
              });
            }
          });
          
          markersLayer.addLayer(marker);
        });
      }
      
      function updateStats() {
        // Update quality stats
        let highQuality = 0, mediumQuality = 0, lowQuality = 0, improved = 0;
        
        filteredEvents.forEach(event => {
          const confidence = parseFloat(event.location_confidence || 0);
          
          if (confidence >= 0.75) highQuality++;
          else if (confidence >= 0.5) mediumQuality++;
          else lowQuality++;
          
          if (event.correction_method && event.correction_method !== 'original') {
            improved++;
          }
        });
        
        document.getElementById('quality-high').textContent = highQuality;
        document.getElementById('quality-medium').textContent = mediumQuality;
        document.getElementById('quality-low').textContent = lowQuality;
        document.getElementById('quality-improved').textContent = improved;
        
        // Update main stats (only for all events, not filtered)
        if (selectedYear === 'all' && selectedTypes.size === document.querySelectorAll('#violence-types input').length) {
          document.getElementById('total-events').textContent = allEvents.length;
          
          const allHighQuality = allEvents.filter(e => parseFloat(e.location_confidence || 0) >= 0.75).length;
          document.getElementById('high-quality').textContent = allHighQuality;
        }
      }
      
      // Expose loadData globally for manual refresh
      window.refreshData = loadData;
      
      // Add keyboard shortcut for refresh (Ctrl+R or F5)
      document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
          e.preventDefault();
          console.log('🔄 Manual refresh triggered');
          loadData();
        }
      });
    </script>
</body>
</html>

